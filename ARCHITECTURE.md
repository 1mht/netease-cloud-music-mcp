# 架构设计文档

> **阅读时间**：10-15分钟
> **目标读者**：想要了解系统设计思路的开发者和用户

---

## 一、问题定义

### 1.1 场景背景

网易云音乐评论区是一个独特的文化现象：
- 热门歌曲拥有 **200万+** 条评论
- 评论跨越 **20年** 时间跨度
- 既有情感树洞，也有文案博物馆

**核心问题**：如何让 AI 理解一个评论区？

### 1.2 技术挑战

| 挑战 | 具体描述 |
|-----|---------|
| **数据量巨大** | 200万条评论 ≈ 1.5亿 token，AI 无法全部处理 |
| **API 限制** | offset 参数只能访问最近 ~1100 条 |
| **时间成本** | 全量爬取需要 2-6 小时，用户无法接受 |
| **Token 限制** | 无法将所有评论发给 AI |
| **偏差风险** | 只看热评会有平台推荐偏差 |

### 1.3 问题重新定义

> **原始问题**：如何获取和分析 200万条评论？
> **重新定义**：如何用 600-1000 条评论让 AI 理解 200万条评论的评论区？

这把问题从"大数据处理"变成了"采样与推断"。

---

## 二、方案设计理念

### 2.1 核心设计原则

#### 原则一：白盒设计
完全透明，让 AI 知道我们做了什么、没做什么、以及局限在哪里。

```
透明告知的内容：
├── 数据边界：数据库有多少条、API说有多少、覆盖率多少
├── 时间范围：最早/最新评论、哪些年份有采样
├── 算法局限：情感分析的置信度、已知的误判类型
└── 采样方法：热评来源、最新评论来源、历史评论来源
```

#### 原则二：职责边界
明确 MCP 工具做什么、不做什么：

**✓ 工具的职责：**
- 采样：从 200万 → 1000条
- 量化：计算情感分数、提取关键词、统计分布
- 透明告知：覆盖率、时间范围、算法局限
- 提供样本：让 AI 自己阅读原文

**✗ 工具不做：**
- 生成结论："听众很喜欢这首歌"
- 价值判断："这是一首好歌"
- 因果解释："因为疫情导致情感下降"
- 隐藏问题：假装数据完整

#### 原则三：渐进式加载
AI 不需要一次性获取所有数据，而是按需加载：

```
Layer 0: 先看边界 → 决定是否需要采样
Layer 1: 看量化信号 → 决定哪些需要验证
Layer 2: 看验证样本 → 验证信号是否准确
Layer 2.5: 查关键词 → 在 DB 中验证信号
Layer 3: 看原始评论 → 深入特定问题
```

---

## 三、系统架构

### 3.1 整体流程

```
┌─────────────────────────────────────────────────────────────┐
│                      用户请求                                 │
│              "帮我分析《晴天》的评论"                           │
└─────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                 搜索 → 确认 → 入库                            │
│   search_songs → confirm_song_selection → add_song          │
└─────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                    采样系统                                   │
│                                                              │
│  职责：从 API 获取评论，存入数据库                              │
│  工具：sample_comments_tool (quick/standard/deep)            │
│                                                              │
│  策略：热评(15) + 最新(offset) + 历史(cursor)                 │
└─────────────────────────────────────────────────────────────┘
                        │
                        ▼ 数据入库
┌─────────────────────────────────────────────────────────────┐
│                    分析系统                                   │
│                                                              │
│  职责：从数据库读取评论，渐进式分析                              │
│  工具：Layer 0 → Layer 1 → Layer 2 → Layer 2.5 → Layer 3      │
└─────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                   AI 生成报告                                 │
│           （带证据引用，承认局限）                              │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 采样系统

#### 设计理念
采样不是随机抽取，而是**三维度结构化采样**。

#### 三部分固定结构

```
每次采样都包含：

┌──────────────────────────────────────────────────────────┐
│ 1. 热评 (固定15条)                                        │
│    来源：API hotComments                                  │
│    价值：代表"出圈"的内容，了解传播最广的观点                │
│    局限：有平台推荐偏差                                     │
├──────────────────────────────────────────────────────────┤
│ 2. 最新评论 (offset翻页)                                  │
│    来源：offset=0 开始翻页                                │
│    价值：捕捉当前评论区氛围                                 │
│    局限：只能覆盖最近几个月                                 │
├──────────────────────────────────────────────────────────┤
│ 3. 历史评论 (cursor跳转)                                  │
│    来源：cursor设为每年的时间戳                            │
│    价值：保证时间线覆盖，发现长期趋势                        │
│    局限：每年采样点有限                                     │
└──────────────────────────────────────────────────────────┘
```

#### 三级采样量

| 级别 | 目标数量 | 适用场景 | 耗时 |
|------|---------|----------|------|
| **quick** | 200 | 快速预览 | ~30秒 |
| **standard** | 600 | 日常分析（推荐） | ~60秒 |
| **deep** | 1000 | 深度研究 | ~100秒 |

#### 动态分配策略

根据歌曲年龄调整比例：

| 歌曲类型 | 年份跨度 | offset比例 | 历史比例 |
|---------|---------|-----------|---------|
| 新歌 | ≤2年 | 100% | 0% |
| 中等新 | 3-5年 | 20% | 80% |
| 正常 | 6-10年 | 30% | 70% |
| 老歌 | >10年 | 30% | 70% |

### 3.3 分析系统

#### 五层分层架构（含 Layer 2.5 验证）

```
Layer 0: 数据概览 (边界层)
  └─ 告诉 AI：有多少数据、覆盖率、时间跨度
  └─ AI 决策：数据是否足够？要不要采样？

Layer 1: 六维度信号 (信号层)
  └─ 提供：情感、内容、时间、结构、社交、语言分析
  └─ AI 决策：哪些信号有价值？哪些需要验证？

Layer 2: 验证样本 (验证层)
  └─ 提供：锚点样本 + 对比样本
  └─ AI 决策：阅读真实评论，验证算法判断

Layer 2.5: 关键词检索 (验证层)
  └─ 用于：在 DB 中验证关键词/主题信号是否真实存在
  └─ AI 决策：需要进一步深挖还是修正解读

Layer 3: 原始评论 (深挖层)
  └─ 提供：按条件筛选的原始评论
  └─ AI 决策：深入特定问题
```

### 3.4 六维度分析

不只是情感分析，而是全方位理解：

| 维度 | 分析内容 | 置信度 | 说明 |
|-----|---------|--------|------|
| **sentiment** | 情感分布 | 0.5-0.7 | SnowNLP，对感伤式金句可能误判 |
| **content** | 主题关键词 | 0.7 | TF-IDF 提取关键词（weight 非占比），可用 doc_ratio / Layer 2.5 验证 |
| **temporal** | 时间趋势 | 0.7 | 年份统计，有采样偏差 |
| **structural** | 长度分布 | 0.9 | 纯统计，最可靠 |
| **social** | 点赞集中度 | 0.85 | 基尼系数，较可靠 |
| **linguistic** | 评论类型 | 0.6 | 规则分类，较粗糙 |

---

## 四、核心技术突破

### 4.1 cursor 参数发现

**问题**：网易云 API 的 offset 参数有限制，超过 ~1100 条返回空。

**解决**：通过 API 逆向分析，发现 cursor 参数可以跳转到任意历史时间点。

| 对比 | offset翻页 | cursor跳转 |
|------|-----------|-----------|
| 可访问范围 | 最近~1100条 | 任意历史时间 |
| 时间覆盖 | 最近几个月 | 可达十几年 |
| 适用场景 | 最新评论 | 历史评论 |

### 4.2 算法盲区纠偏

**问题**：SnowNLP 对"感伤式金句"误判为负面。

**示例**：
| 评论原文 | 算法判断 | 实际含义 |
|----------|---------|---------|
| "我失去了最好的朋友" | 负面 | 深情怀念 |
| "每次听都想起她，眼泪流下来" | 负面 | 情感共鸣 |

**解决**：提供"对比样本"（高赞低分），让 AI 阅读原文自己判断。

### 4.3 强制流程检查

**问题**：AI 可能跳过采样，直接用不足的数据分析。

**解决**：在 Layer 0 和 Layer 1 设置阻断机制：

```python
if db_count < 100:
    return {
        "status": "must_sample_first",
        "blocking_reason": "数据量不足",
        "required_action": "先调用 sample_comments_tool"
    }
```

---

## 五、设计决策与权衡

### 5.1 为什么不全量爬取？

| 方案 | 时间成本 | 用户体验 | 数据完整性 |
|------|---------|---------|-----------|
| 全量爬取 | 2-6小时 | ❌ 不可接受 | ✓ 100% |
| 分层采样 | 30-100秒 | ✓ 可接受 | ~0.05% |

**决策**：选择分层采样，但透明告知局限。

### 5.2 为什么工具不下结论？

**传统做法**：
```
"情感分析结果：正面 67%"
"结论：听众普遍喜欢这首歌"  ← 可能误导
```

**我们的做法**：
```
"情感分布：正面 67%"
"置信度：0.6"
"局限：对感伤式金句可能误判"
"建议：查看高赞低分样本验证"
[提供样本]  ← AI 自己判断
```

### 5.3 为什么需要对比样本？

**对比样本的设计**：

```
high_likes_low_score（高赞低分）：
  选择条件：点赞 > 1000 且 情感分数 < 0.3
  意义：用户认可但算法判负面
  用途：发现情感分析误判

low_likes_but_long（低赞长文）：
  选择条件：点赞 < 100 且 字数 > 100
  意义：内容丰富但没被发现
  用途：发现被埋没的深度内容
```

---

## 六、数据库设计

### 6.1 核心表结构

```sql
-- 歌曲表
CREATE TABLE songs (
    id VARCHAR(64) PRIMARY KEY,
    name VARCHAR(255),
    artist VARCHAR(255),
    album VARCHAR(255),
    publish_time BIGINT,

    cache_level VARCHAR(20),              -- none/basic/sampled
    cache_updated_at BIGINT,
    api_total_comments_snapshot INTEGER
);

-- 评论表
CREATE TABLE comments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    comment_id VARCHAR(64) UNIQUE,
    song_id VARCHAR(64),

    content TEXT,
    user_id VARCHAR(64),
    user_name VARCHAR(255),

    liked_count INTEGER,
    timestamp BIGINT,
    is_hot INTEGER DEFAULT 0,

    is_deleted INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 6.2 设计理念

数据库 = 智能缓存：
1. 避免重复请求 API
2. 支持增量采样
3. 记录元数据支撑透明度

---

## 七、典型使用流程

```
用户："帮我分析《晴天》的评论区"

Step 1: 搜索 → 确认 → 入库
  AI: search_songs_tool("晴天")
  用户: 选择 "晴天 - 周杰伦"
  AI: confirm_song_selection_tool(choice=1)
  AI: add_song_to_database(song_id)

Step 2: Layer 0 查看边界
  AI: get_analysis_overview_tool(song_id)
  返回: db_count=15, 不足100
  系统: 阻断，要求先采样

Step 3: 采样
  AI: sample_comments_tool(song_id, level="standard")
  返回: 采样600条，覆盖21年

Step 4: Layer 1 六维度信号
  AI: get_analysis_signals_tool(song_id)
  发现: 18条高赞低分评论

Step 5: Layer 2 验证样本
  AI: get_analysis_samples_tool(song_id)
  阅读: 高赞低分样本
  判断: 是感伤式金句，非负面

Step 6: 生成报告
  AI: 输出分析报告（修正了算法误判）
```

---

## 八、项目价值

> **核心价值**：让 AI 在有限样本上做可靠推断，并清楚自己的局限。

**具体展开**：

1. **解决了"大数据给AI"的问题**
   - 200万条 → 1000条代表性样本
   - 快速（1分钟）且有效

2. **白盒设计建立信任**
   - AI 知道数据从哪来
   - AI 知道算法的局限
   - AI 可以诚实说明

3. **AI 可以"质疑"**
   - 不只是接受量化结果
   - 可以阅读原文验证
   - 可以发现算法盲区

---

## 九、未来方向

```
当前不足：
1. 采样仍有偏差（0.1%覆盖率）
2. 算法局限明显（依赖 AI 修正）
3. 单歌曲分析（还不支持对比）

未来计划：
1. 歌曲对比分析
2. 歌单整体画像
3. 更多平台接入（QQ音乐、Spotify）
4. 更好的情感分析模型
5. Web 版本（降低使用门槛）
```

---

## 十、技术栈

- **MCP Framework**: [FastMCP](https://github.com/jlowin/fastmcp)
- **NLP**: jieba 分词 + SnowNLP 情感分析
- **Database**: SQLite
- **API**: 网易云音乐 weapi

---

## 联系与反馈

如需更详细的技术文档或有合作意向，请通过以下方式联系：

- **GitHub Issues**: [提问题](https://github.com/1mht/netease-cloud-music-mcp/issues)
- **Email**: （如需提供可在此添加）

---

**本文档提供了系统的核心设计思路。更详细的实现细节请参考源代码。**
